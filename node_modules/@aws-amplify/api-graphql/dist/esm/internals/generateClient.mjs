import { graphql, cancel, isCancelError } from './v6.mjs';
import { generateModelsProperty } from './generateModelsProperty.mjs';
import { __amplify, __authMode, __authToken, __headers } from '../types/index.mjs';
import { Hub } from '@aws-amplify/core';

// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
/**
 * @private
 *
 * Creates a client that can be used to make GraphQL requests, using a provided `AmplifyClassV6`
 * compatible context object for config and auth fetching.
 *
 * @param params
 * @returns
 */
function generateClient(params) {
    const client = {
        [__amplify]: params.amplify,
        [__authMode]: params.authMode,
        [__authToken]: params.authToken,
        [__headers]: params.headers,
        graphql,
        cancel,
        isCancelError,
        models: {},
    };
    const config = params.amplify.getConfig();
    if (!config.API?.GraphQL) {
        // This happens when the `Amplify.configure()` call gets evaluated after the `generateClient()` call.
        //
        // Cause: when the `generateClient()` and the `Amplify.configure()` calls are located in
        // different source files, script bundlers may randomly arrange their orders in the production
        // bundle.
        //
        // With the current implementation, the `client.models` instance created by `generateClient()`
        // will be rebuilt on every `Amplify.configure()` call that's provided with a valid GraphQL
        // provider configuration.
        //
        // TODO: revisit, and reverify this approach when enabling multiple clients for multi-endpoints
        // configuration.
        client.models = emptyModels;
        generateModelsPropertyOnAmplifyConfigure(client);
    }
    else {
        client.models = generateModelsProperty(client, config.API?.GraphQL);
    }
    return client;
}
const generateModelsPropertyOnAmplifyConfigure = (clientRef) => {
    Hub.listen('core', coreEvent => {
        if (!isConfigureEvent(coreEvent.payload)) {
            return;
        }
        const { data: resourceConfig } = coreEvent.payload;
        if (resourceConfig.API?.GraphQL) {
            clientRef.models = generateModelsProperty(clientRef, resourceConfig.API?.GraphQL);
        }
    });
};
function isConfigureEvent(payload) {
    return payload.event === 'configure';
}
const emptyModels = new Proxy({}, {
    get() {
        throw new Error('Could not generate client. This is likely due to Amplify.configure() not being called prior to generateClient().');
    },
});

export { generateClient };
//# sourceMappingURL=generateClient.mjs.map
